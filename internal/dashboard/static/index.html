<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VC Jump</title>
    <!-- xterm.js for terminal emulation (offline) -->
    <link rel="stylesheet" href="/static/vendor/xterm.css">
    <script src="/static/vendor/xterm.min.js"></script>
    <script src="/static/vendor/xterm-addon-fit.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: monospace; background: #fff; font-size: 14px; }
        a { color: #00f; }
        
        /* Login */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #eee; }
        .login-box { background: #fff; padding: 20px; border: 1px solid #999; width: 300px; }
        .login-box h1 { font-size: 18px; margin-bottom: 15px; text-align: center; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 3px; }
        .form-group input, .form-group select { width: 100%; padding: 6px; border: 1px solid #999; font-family: monospace; }
        .btn { width: 100%; padding: 8px; background: #333; color: #fff; border: none; cursor: pointer; font-family: monospace; }
        .btn:hover { background: #000; }
        .error { color: #c00; margin-top: 10px; text-align: center; font-size: 12px; }
        
        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .login-container.hidden { display: none; }
        
        nav { background: #333; color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        nav h1 { font-size: 14px; font-weight: normal; }
        .logout-btn { background: #c00; color: #fff; border: none; padding: 5px 10px; cursor: pointer; font-family: monospace; font-size: 12px; }
        
        .main-content { display: flex; min-height: calc(100vh - 40px); }
        .sidebar { width: 150px; background: #f5f5f5; border-right: 1px solid #ccc; }
        .sidebar ul { list-style: none; }
        .sidebar a { display: block; padding: 8px 10px; color: #333; text-decoration: none; border-bottom: 1px solid #ddd; font-size: 12px; }
        .sidebar a:hover, .sidebar a.active { background: #ddd; }
        
        .content { flex: 1; padding: 15px; }
        .content h2 { font-size: 14px; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        
        /* Stats */
        .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat { background: #f5f5f5; padding: 10px 15px; border: 1px solid #ccc; }
        .stat-label { font-size: 11px; color: #666; }
        .stat-value { font-size: 20px; font-weight: bold; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 6px 8px; text-align: left; border: 1px solid #ccc; }
        th { background: #f0f0f0; font-weight: bold; }
        tr:hover { background: #f9f9f9; }
        code { background: #f0f0f0; padding: 1px 4px; font-size: 11px; }
        
        /* Buttons */
        .btn-sm { padding: 3px 8px; font-size: 11px; cursor: pointer; border: 1px solid #999; background: #fff; font-family: monospace; }
        .btn-sm:hover { background: #eee; }
        .btn-add { background: #333; color: #fff; border: none; margin-bottom: 10px; }
        .btn-add:hover { background: #000; }
        .btn-del { background: #c00; color: #fff; border: none; }
        .btn-del:hover { background: #900; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 15px; border: 1px solid #333; width: 350px; }
        .modal-content h3 { font-size: 14px; margin-bottom: 15px; }
        .modal-actions { margin-top: 15px; text-align: right; }
        .modal-actions button { margin-left: 5px; }
        
        .section { display: none; }
        .section.active { display: block; }
        .active-badge { color: #090; }
        .iam-tab { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>VC Jump Login</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
                <div class="error" id="loginError"></div>
            </form>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <nav>
            <h1>VC Jump - <span id="currentUser"></span></h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </nav>
        <div class="main-content">
            <div class="sidebar">
                <ul>
                    <li><a href="#overview" data-section="overview">Overview</a></li>
                    <li><a href="#hosts" data-section="hosts" data-permission="host:view">Hosts</a></li>
                    <li><a href="#users" data-section="users" data-permission="user:view">Users</a></li>
                    <li><a href="#keys" data-section="keys" data-permission="sshkey:view">SSH Keys</a></li>
                    <li><a href="#sessions" data-section="sessions" data-permission="session:view">Sessions</a></li>
                    <li><a href="#recordings" data-section="recordings" data-permission="recording:view">Recordings</a></li>
                    <li><a href="#iam" data-section="iam" data-permission="iam:view">IAM</a></li>
                    <li><a href="#settings" data-section="settings" data-permission="settings:view">Settings</a></li>
                </ul>
            </div>
            <div class="content">
                <div class="section active" id="section-overview">
                    <h2>Overview</h2>
                    <div class="stats">
                        <div class="stat"><div class="stat-label">Hosts</div><div class="stat-value" id="stat-hosts">0</div></div>
                        <div class="stat"><div class="stat-label">Users</div><div class="stat-value" id="stat-users">0</div></div>
                        <div class="stat"><div class="stat-label">Active</div><div class="stat-value" id="stat-active-sessions">0</div></div>
                        <div class="stat"><div class="stat-label">Keys</div><div class="stat-value" id="stat-keys">0</div></div>
                    </div>
                </div>

                <div class="section" id="section-hosts">
                    <h2>Hosts</h2>
                    <button class="btn-sm btn-add" onclick="showModal('addHostModal')" data-perm-create="host:create">+ Add Host</button>
                    <table>
                        <thead><tr><th>Name</th><th>Address</th><th>Port</th><th>SSH Key</th><th>Users</th><th>Action</th></tr></thead>
                        <tbody id="hosts-table"></tbody>
                    </table>
                </div>

                <div class="section" id="section-users">
                    <h2>Users</h2>
                    <button class="btn-sm btn-add" onclick="openAddUserModal()" data-perm-create="user:create">+ Add User</button>
                    <table>
                        <thead><tr><th>Username</th><th>Role</th><th>Source</th><th>Groups</th><th>Allowed Hosts</th><th>Status</th><th>Last Login</th><th>Action</th></tr></thead>
                        <tbody id="users-table"></tbody>
                    </table>
                </div>

                <div class="section" id="section-keys">
                    <h2>SSH Keys</h2>
                    <button class="btn-sm btn-add" onclick="showModal('addKeyModal')" data-perm-create="sshkey:create">+ Generate Key</button>
                    <table>
                        <thead><tr><th>Name</th><th>Type</th><th>Fingerprint</th><th>Used By</th><th>Created</th><th>Action</th></tr></thead>
                        <tbody id="keys-table"></tbody>
                    </table>
                </div>

                <div class="section" id="section-sessions">
                    <h2>Sessions</h2>
                    <button class="btn-sm" onclick="loadSessions()">Refresh</button>
                    
                    <h3 style="margin-top:20px">Live Sessions (Real-time Viewing)</h3>
                    <table style="margin-top:10px">
                        <thead><tr><th>User</th><th>Target</th><th>Start</th><th>Duration</th><th>Action</th></tr></thead>
                        <tbody id="live-sessions-table"></tbody>
                    </table>
                    
                    <h3 style="margin-top:20px">Active Sessions</h3>
                    <table style="margin-top:10px">
                        <thead><tr><th>User</th><th>Source</th><th>Target</th><th>Start</th><th>Duration</th></tr></thead>
                        <tbody id="active-sessions-table"></tbody>
                    </table>
                    
                    <h3 style="margin-top:30px">Session History</h3>
                    <table style="margin-top:10px">
                        <thead><tr><th>User</th><th>Source</th><th>Target</th><th>Start</th><th>End</th><th>Recording</th></tr></thead>
                        <tbody id="sessions-table"></tbody>
                    </table>
                </div>

                <div class="section" id="section-recordings">
                    <h2>Session Recordings</h2>
                    <div style="margin-bottom:10px;display:flex;gap:10px;align-items:center">
                        <button class="btn-sm" onclick="loadRecordings()">Refresh</button>
                        <button class="btn-sm btn-del" id="batchDeleteBtn" onclick="showBatchDeleteConfirm()" style="display:none">Delete Selected (<span id="selectedCount">0</span>)</button>
                        <label style="font-size:12px;cursor:pointer">
                            <input type="checkbox" id="selectAllRecordings" onchange="toggleSelectAll(this.checked)"> Select All
                        </label>
                    </div>
                    <table style="margin-top:10px">
                        <thead><tr><th style="width:30px"><input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll(this.checked)"></th><th>Filename</th><th>Size</th><th>Date</th><th>Action</th></tr></thead>
                        <tbody id="recordings-table"></tbody>
                    </table>
                </div>

                <div class="section" id="section-iam">
                    <h2>Identity & Access Management</h2>
                    <div style="display:flex;gap:10px;margin-bottom:15px">
                        <button class="btn-sm" id="iamTabRoles" onclick="showIamTab('roles')" style="background:#333;color:#fff">Roles</button>
                        <button class="btn-sm" id="iamTabUserRoles" onclick="showIamTab('user-roles')">User Roles</button>
                        <button class="btn-sm" id="iamTabHostPerms" onclick="showIamTab('host-perms')">Host Permissions</button>
                    </div>

                    <div id="iam-roles" class="iam-tab">
                        <button class="btn-sm btn-add" onclick="showModal('addRoleModal')">+ Add Role</button>
                        <table style="margin-top:10px">
                            <thead><tr><th>Name</th><th>Display Name</th><th>Description</th><th>Permissions</th><th>System</th><th>Action</th></tr></thead>
                            <tbody id="roles-table"></tbody>
                        </table>
                    </div>

                    <div id="iam-user-roles" class="iam-tab" style="display:none">
                        <button class="btn-sm btn-add" onclick="showModal('assignRoleModal')">+ Assign Role</button>
                        <table style="margin-top:10px">
                            <thead><tr><th>User</th><th>Roles</th><th>Action</th></tr></thead>
                            <tbody id="user-roles-table"></tbody>
                        </table>
                    </div>

                    <div id="iam-host-perms" class="iam-tab" style="display:none">
                        <button class="btn-sm btn-add" onclick="showModal('grantHostModal')">+ Grant Access</button>
                        <table style="margin-top:10px">
                            <thead><tr><th>User</th><th>Host</th><th>Actions</th><th>Granted By</th><th>Expires</th><th>Action</th></tr></thead>
                            <tbody id="host-perms-table"></tbody>
                        </table>
                    </div>
                </div>

                <div class="section" id="section-settings">
                    <h2>Settings</h2>
                    
                    <h3 style="margin-top:20px">üîê Your OTP Settings</h3>
                    <div id="otp-user-settings" style="margin-top:10px;padding:15px;background:#f9f9f9;border:1px solid #ddd">
                        <div id="otp-status-display">Loading...</div>
                    </div>
                    
                    <h3 style="margin-top:30px">üîí Global Security Settings (Admin Only)</h3>
                    <div style="margin-top:10px;padding:15px;background:#f9f9f9;border:1px solid #ddd">
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                            <input type="checkbox" id="otpForceEnabled" onchange="updateOTPGlobalSetting()">
                            <span>Force OTP for all users</span>
                        </label>
                        <p style="font-size:11px;color:#666;margin-top:5px">When enabled, all users must verify OTP before accessing hosts.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recording Player Modal -->
    <div class="modal" id="playerModal">
        <div class="modal-content" style="width:90%;max-width:1000px;max-height:90vh;overflow:hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <h3 id="playerTitle">Recording Playback</h3>
                <span class="close" onclick="closeModal('playerModal')" style="cursor:pointer;font-size:20px">&times;</span>
            </div>
            <div id="terminal-container" style="height:450px;background:#000;border-radius:4px;overflow:hidden"></div>
            <div style="margin-top:15px;display:flex;align-items:center;gap:15px;flex-wrap:wrap">
                <button class="btn-sm" id="playBtn" onclick="togglePlayback()" style="min-width:70px">‚ñ∂ Play</button>
                <button class="btn-sm" onclick="restartPlayback()">‚ü≤ Restart</button>
                <div style="display:flex;align-items:center;gap:5px">
                    <span>Speed:</span>
                    <select id="playbackSpeed" onchange="updatePlaybackSpeed()" style="padding:3px">
                        <option value="0.25">0.25x</option>
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                        <option value="8">8x</option>
                    </select>
                </div>
                <div style="flex:1;display:flex;align-items:center;gap:10px">
                    <span id="currentTime">0:00</span>
                    <input type="range" id="progressBar" min="0" max="100" value="0" 
                           style="flex:1;cursor:pointer" onchange="seekTo(this.value)" oninput="seekPreview(this.value)">
                    <span id="totalTime">0:00</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addHostModal">
        <div class="modal-content">
            <h3 id="hostModalTitle">Add Host</h3>
            <form id="addHostForm">
                <input type="hidden" name="id" id="hostEditId">
                <div class="form-group"><label>Name</label><input type="text" name="name" id="hostName" required></div>
                <div class="form-group"><label>Address</label><input type="text" name="addr" id="hostAddr" required></div>
                <div class="form-group"><label>Port</label><input type="number" name="port" id="hostPort" value="22" required></div>
                <div class="form-group"><label>SSH User</label><input type="text" name="user" id="hostUser" placeholder="e.g., root"></div>
                <div class="form-group"><label>SSH Key</label><select name="key_id" id="hostKeyId"><option value="">-- None --</option></select></div>
                <div class="form-group"><label>Groups (comma sep)</label><input type="text" name="groups" id="hostGroups"></div>
                <div class="form-group"><label><input type="checkbox" name="insecure_ignore_host_key" id="hostInsecure"> Skip Host Key Verification</label></div>
                <div class="modal-actions">
                    <button type="button" class="btn-sm" onclick="closeModal('addHostModal')">Cancel</button>
                    <button type="submit" class="btn-sm btn-add" id="hostSubmitBtn">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <h3 id="userModalTitle">Add User</h3>
            <form id="addUserForm">
                <input type="hidden" name="id" id="userEditId">
                <div class="form-group"><label>Username</label><input type="text" name="username" id="userUsername" required></div>
                <div class="form-group" id="passwordGroup"><label>Password</label><input type="password" name="password" id="userPassword" required></div>
                <div class="form-group" id="roleGroup"><label>Roles</label><select name="role_ids" id="userRoles" multiple style="height:80px"><option value="">Loading roles...</option></select><small style="color:#888">Hold Ctrl/Cmd to select multiple roles</small></div>
                <div class="form-group" id="groupsGroup"><label>Group</label><select name="groups" id="userGroups"><option value="">Select a group...</option></select></div>
                <div class="form-group" id="allowedHostsGroup"><label>Allowed Hosts</label><select name="allowed_hosts" id="userAllowedHosts" multiple style="height:100px"></select><small style="color:#888">Leave empty = no access. Hold Ctrl/Cmd to select multiple</small></div>
                <div class="modal-actions">
                    <button type="button" class="btn-sm" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn-sm btn-add" id="userSubmitBtn">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addKeyModal">
        <div class="modal-content">
            <h3>Generate SSH Key</h3>
            <form id="addKeyForm">
                <div class="form-group"><label>Name</label><input type="text" name="name" required></div>
                <div class="form-group">
                    <label>Type</label>
                    <select name="key_type">
                        <option value="ed25519">ED25519</option>
                        <option value="rsa-4096">RSA 4096</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-sm" onclick="closeModal('addKeyModal')">Cancel</button>
                    <button type="submit" class="btn-sm btn-add">Generate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Dialog Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="width:400px">
            <h3 id="confirmTitle">Confirm</h3>
            <p id="confirmMessage" style="margin:15px 0;font-size:13px"></p>
            <div id="confirmDetails" style="max-height:150px;overflow-y:auto;background:#f5f5f5;padding:10px;font-size:11px;margin-bottom:15px;display:none"></div>
            <div class="modal-actions">
                <button type="button" class="btn-sm" id="confirmCancelBtn" onclick="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn-sm btn-del" id="confirmOkBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Live Session Watch Modal -->
    <div class="modal" id="watchSessionModal">
        <div class="modal-content" style="width:900px;max-width:95vw;height:600px;max-height:85vh;display:flex;flex-direction:column">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <h3 id="watchSessionTitle">Live Session</h3>
                <button type="button" class="btn-sm" onclick="closeWatchSession()">‚úï Close</button>
            </div>
            <div id="watchTerminal" style="flex:1;background:#000;border-radius:4px;overflow:hidden"></div>
        </div>
    </div>

    <!-- Add Role Modal -->
    <div class="modal" id="addRoleModal">
        <div class="modal-content" style="width:450px">
            <h3 id="roleModalTitle">Add Role</h3>
            <form id="addRoleForm">
                <input type="hidden" name="id" id="roleEditId">
                <div class="form-group"><label>Name (unique key)</label><input type="text" name="name" id="roleName" required pattern="[a-z0-9_-]+" title="lowercase letters, numbers, hyphens, underscores"></div>
                <div class="form-group"><label>Display Name</label><input type="text" name="display_name" id="roleDisplayName" required></div>
                <div class="form-group"><label>Description</label><input type="text" name="description" id="roleDescription"></div>
                <div class="form-group">
                    <label>Permissions</label>
                    <div id="permissionCheckboxes" style="max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:8px;font-size:11px"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-sm" onclick="closeModal('addRoleModal')">Cancel</button>
                    <button type="submit" class="btn-sm btn-add" id="roleSubmitBtn">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Role Modal -->
    <div class="modal" id="assignRoleModal">
        <div class="modal-content">
            <h3>Assign Role to User</h3>
            <form id="assignRoleForm">
                <div class="form-group">
                    <label>User</label>
                    <select name="user_id" id="assignRoleUserId" required></select>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role_id" id="assignRoleRoleId" required></select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-sm" onclick="closeModal('assignRoleModal')">Cancel</button>
                    <button type="submit" class="btn-sm btn-add">Assign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Grant Host Access Modal -->
    <div class="modal" id="grantHostModal">
        <div class="modal-content">
            <h3>Grant Host Access</h3>
            <form id="grantHostForm">
                <div class="form-group">
                    <label>User</label>
                    <select name="user_id" id="grantHostUserId" required></select>
                </div>
                <div class="form-group">
                    <label>Host</label>
                    <select name="host_id" id="grantHostHostId" required></select>
                </div>
                <div class="form-group">
                    <label>Actions</label>
                    <div id="hostActionCheckboxes" style="font-size:12px">
                        <label style="margin-right:10px"><input type="checkbox" name="actions" value="connect" checked> Connect</label>
                        <label style="margin-right:10px"><input type="checkbox" name="actions" value="view"> View</label>
                        <label style="margin-right:10px"><input type="checkbox" name="actions" value="sudo"> Sudo</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Expires At (optional)</label>
                    <input type="datetime-local" name="expires_at" id="grantHostExpires">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-sm" onclick="closeModal('grantHostModal')">Cancel</button>
                    <button type="submit" class="btn-sm btn-add">Grant</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let currentUser = null;
        let userPermissions = [];
        let allRoles = []; // Cache for roles (used by Users and IAM)

        // Permission check helper
        function hasPermission(perm) {
            return userPermissions.includes(perm);
        }

        if (token) checkAuth();

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const err = document.getElementById('loginError');
            err.textContent = '';
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Login failed');
                token = data.token;
                localStorage.setItem('token', token);
                currentUser = data.user;
                await loadUserPermissions();
                showDashboard();
            } catch (e) { err.textContent = e.message; }
        };

        async function loadUserPermissions() {
            try {
                const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data;
                    userPermissions = data.permissions || [];
                }
            } catch (e) { userPermissions = []; }
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    currentUser = await res.json();
                    userPermissions = currentUser.permissions || [];
                    showDashboard();
                }
                else { localStorage.removeItem('token'); token = null; }
            } catch (e) { localStorage.removeItem('token'); token = null; }
        }

        let allKeys = []; // cache for key dropdown
        let allHosts = []; // cache for allowed_hosts display

        function showDashboard() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('currentUser').textContent = currentUser.username;
            
            // Apply permission-based visibility
            applyPermissions();
            
            loadKeysCache(); // preload keys for dropdown
            
            // Initialize routing
            initRouter();
        }

        function applyPermissions() {
            // Hide sidebar items based on permissions
            document.querySelectorAll('.sidebar a[data-permission]').forEach(el => {
                const requiredPerm = el.getAttribute('data-permission');
                if (requiredPerm && !hasPermission(requiredPerm)) {
                    el.parentElement.style.display = 'none';
                } else {
                    el.parentElement.style.display = '';
                }
            });

            // Hide add buttons based on permissions
            document.querySelectorAll('[data-perm-create]').forEach(el => {
                const requiredPerm = el.getAttribute('data-perm-create');
                el.style.display = hasPermission(requiredPerm) ? '' : 'none';
            });

            // Hide delete buttons based on permissions
            document.querySelectorAll('[data-perm-delete]').forEach(el => {
                const requiredPerm = el.getAttribute('data-perm-delete');
                el.style.display = hasPermission(requiredPerm) ? '' : 'none';
            });

            // Hide edit buttons based on permissions
            document.querySelectorAll('[data-perm-update]').forEach(el => {
                const requiredPerm = el.getAttribute('data-perm-update');
                el.style.display = hasPermission(requiredPerm) ? '' : 'none';
            });
        }

        async function loadKeysCache() {
            try {
                allKeys = await (await fetch('/api/keys', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
            } catch (e) { allKeys = []; }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
            localStorage.removeItem('token');
            location.reload();
        }

        // ============================================================
        // Hash-based Routing
        // ============================================================
        const validSections = ['overview', 'hosts', 'users', 'keys', 'sessions', 'recordings', 'iam', 'settings'];
        
        // Map sections to required permissions
        const sectionPermissions = {
            'overview': null, // Everyone can see overview
            'hosts': 'host:view',
            'users': 'user:view',
            'keys': 'sshkey:view',
            'sessions': 'session:view',
            'recordings': 'recording:view',
            'iam': 'iam:view',
            'settings': 'settings:view'
        };
        
        function initRouter() {
            // Listen for hash changes
            window.addEventListener('hashchange', handleRouteChange);
            
            // Handle initial route
            handleRouteChange();
        }
        
        function handleRouteChange() {
            let hash = window.location.hash.slice(1); // Remove #
            
            // Default to overview if no hash or invalid hash
            if (!hash || !validSections.includes(hash)) {
                hash = 'overview';
            }
            
            // Check permission for the section
            const requiredPerm = sectionPermissions[hash];
            if (requiredPerm && !hasPermission(requiredPerm)) {
                hash = 'overview'; // Redirect to overview if no permission
            }
            
            // Update URL without triggering another hashchange
            if (window.location.hash !== '#' + hash) {
                history.replaceState(null, '', '#' + hash);
            }
            
            showSection(hash);
        }
        
        function navigateTo(section) {
            window.location.hash = section;
        }

        function showSection(s) {
            // Update sections visibility
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            const sectionEl = document.getElementById('section-' + s);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }
            
            // Update sidebar active state
            document.querySelectorAll('.sidebar a').forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('data-section') === s) {
                    a.classList.add('active');
                }
            });
            
            // Load section data
            if (s === 'overview') loadStats();
            else if (s === 'hosts') loadHosts();
            else if (s === 'users') loadUsers();
            else if (s === 'keys') loadKeys();
            else if (s === 'sessions') loadSessions();
            else if (s === 'recordings') loadRecordings();
            else if (s === 'iam') loadIam();
            else if (s === 'settings') loadSettings();
        }

        async function loadStats() {
            try {
                const data = await (await fetch('/api/stats', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                document.getElementById('stat-hosts').textContent = data.hosts || 0;
                document.getElementById('stat-users').textContent = data.users || 0;
                document.getElementById('stat-active-sessions').textContent = data.active_sessions || 0;
                document.getElementById('stat-keys').textContent = data.ssh_keys || 0;
            } catch (e) {}
        }

        function getKeyName(keyId) {
            if (!keyId) return '-';
            const k = allKeys.find(k => k.id === keyId);
            return k ? k.name : keyId.slice(0,8);
        }

        async function loadHosts() {
            try {
                const hosts = await (await fetch('/api/hosts', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                allHosts = hosts || [];
                const canEdit = hasPermission('host:update');
                const canDelete = hasPermission('host:delete');
                document.getElementById('hosts-table').innerHTML = allHosts.map(h => 
                    `<tr>
                        <td>${h.name}</td>
                        <td>${h.addr}</td>
                        <td>${h.port}</td>
                        <td>${getKeyName(h.key_id)}</td>
                        <td>${h.user || 'root'}</td>
                        <td>
                            ${canEdit ? `<button class="btn-sm" onclick="editHost('${h.id}')">Edit</button>` : ''}
                            ${canDelete ? `<button class="btn-sm btn-del" onclick="deleteHost('${h.id}')">Del</button>` : ''}
                            ${!canEdit && !canDelete ? '-' : ''}
                        </td>
                    </tr>`
                ).join('');
            } catch (e) {}
        }

        function sourceLabel(src) {
            if (src === 'ssh') return '<span style="color:#0af">SSH</span>';
            if (src === 'oidc') return '<span style="color:#fa0">OIDC</span>';
            return 'Local';
        }

        async function loadUsers() {
            try {
                const users = await (await fetch('/api/users', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                const canEdit = hasPermission('user:update');
                const canDelete = hasPermission('user:delete');
                const canManageIAM = hasPermission('iam:manage');
                document.getElementById('users-table').innerHTML = (users || []).map(u => {
                    let actions = '-';
                    if (u.username !== 'admin') {
                        const editBtn = canEdit ? `<button class="btn-sm" onclick="editUser('${u.id}')">Edit</button>` : '';
                        const delBtn = canDelete ? `<button class="btn-sm btn-del" onclick="deleteUser('${u.id}')">Del</button>` : '';
                        actions = (editBtn || delBtn) ? `${editBtn} ${delBtn}` : '-';
                    } else if (canEdit) {
                        actions = `<button class="btn-sm" onclick="editUser('${u.id}')">Edit</button>`;
                    }
                    const roleDisplay = (u.roles || []).join(', ') || '<span style="color:#999">No Role</span>';
                    return `<tr>
                        <td>${u.username}</td>
                        <td>${roleDisplay}</td>
                        <td>${sourceLabel(u.source)}</td>
                        <td>${(u.groups||[]).join(', ') || '-'}</td>
                        <td>${(u.allowed_hosts||[]).join(', ') || '<span style="color:#c00">None</span>'}</td>
                        <td>${u.is_active ? '<span class="active-badge">Active</span>' : 'Inactive'}</td>
                        <td>${u.last_login_at ? new Date(u.last_login_at).toLocaleString() : '-'}</td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            } catch (e) {}
        }

        function getHostsUsingKey(keyId) {
            return allHosts.filter(h => h.key_id === keyId).map(h => h.name).join(', ') || '-';
        }

        async function loadKeys() {
            try {
                const keys = await (await fetch('/api/keys', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                allKeys = keys || [];
                const canDelete = hasPermission('sshkey:delete');
                document.getElementById('keys-table').innerHTML = allKeys.map(k => 
                    `<tr>
                        <td>${k.name}</td>
                        <td>${k.key_type}</td>
                        <td><code style="font-size:11px">${k.fingerprint||'-'}</code></td>
                        <td>${getHostsUsingKey(k.id)}</td>
                        <td>${new Date(k.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-sm" onclick="copyKey('${btoa(k.public_key||'')}')">Copy Pub</button>
                            ${canDelete ? `<button class="btn-sm btn-del" onclick="deleteKey('${k.id}')">Del</button>` : ''}
                        </td>
                    </tr>`
                ).join('');
            } catch (e) {}
        }

        async function loadSessions() {
            try {
                // Load live sessions (for real-time viewing)
                const liveSessions = await (await fetch('/api/sessions/live', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                document.getElementById('live-sessions-table').innerHTML = liveSessions.length ? liveSessions.map(s => {
                    const duration = formatDuration(new Date() - new Date(s.start_time));
                    return `<tr><td>${escapeHtml(s.username)}</td><td>${escapeHtml(s.hostname)}</td><td>${new Date(s.start_time).toLocaleString()}</td><td>${duration}</td><td><button class="btn-sm" style="background:#4CAF50" onclick="watchSession('${escapeJs(s.id)}', '${escapeJs(s.username)}', '${escapeJs(s.hostname)}')">üëÅ Watch Live</button></td></tr>`;
                }).join('') : '<tr><td colspan="5" style="text-align:center;color:#888">No live sessions (recording must be enabled)</td></tr>';
                
                // Load active sessions
                const activeSessions = await (await fetch('/api/sessions/active', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                document.getElementById('active-sessions-table').innerHTML = activeSessions.length ? activeSessions.map(s => {
                    const duration = formatDuration(new Date() - new Date(s.start_time));
                    return `<tr><td>${s.username}</td><td>${s.source_ip}</td><td>${s.target_host}</td><td>${new Date(s.start_time).toLocaleString()}</td><td>${duration}</td></tr>`;
                }).join('') : '<tr><td colspan="5" style="text-align:center;color:#888">No active sessions</td></tr>';

                // Load all sessions (history)
                const sessions = await (await fetch('/api/sessions', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                const historySessions = sessions.filter(s => s.end_time);
                document.getElementById('sessions-table').innerHTML = historySessions.length ? historySessions.map(s => {
                    // Extract filename from recording path (may contain directory prefix).
                    const recordingFile = s.recording ? s.recording.split('/').pop() : null;
                    return `<tr><td>${escapeHtml(s.username)}</td><td>${escapeHtml(s.source_ip)}</td><td>${escapeHtml(s.target_host)}</td><td>${new Date(s.start_time).toLocaleString()}</td><td>${new Date(s.end_time).toLocaleString()}</td><td>${recordingFile ? `<button class="btn-sm" onclick="playRecording('${escapeJs(recordingFile)}')">Play</button>` : '-'}</td></tr>`;
                }).join('') : '<tr><td colspan="6" style="text-align:center;color:#888">No session history</td></tr>';
            } catch (e) { console.error(e); }
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        // Track selected recordings for batch delete.
        let selectedRecordings = new Set();

        async function loadRecordings() {
            try {
                const recordings = await (await fetch('/api/recordings', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                selectedRecordings.clear();
                updateBatchDeleteButton();
                
                // Reset select all checkboxes.
                const selectAllHeader = document.getElementById('selectAllHeader');
                const selectAllRecordings = document.getElementById('selectAllRecordings');
                if (selectAllHeader) selectAllHeader.checked = false;
                if (selectAllRecordings) selectAllRecordings.checked = false;
                
                document.getElementById('recordings-table').innerHTML = recordings.length ? recordings.map(r => 
                    `<tr>
                        <td><input type="checkbox" class="recording-checkbox" data-filename="${escapeHtml(r.name)}" onchange="toggleRecordingSelection('${escapeJs(r.name)}', this.checked)"></td>
                        <td>${escapeHtml(r.name)}</td>
                        <td>${formatSize(r.size)}</td>
                        <td>${new Date(r.mod_time).toLocaleString()}</td>
                        <td>
                            <button class="btn-sm" onclick="playRecording('${escapeJs(r.name)}')">Play</button>
                            <button class="btn-sm btn-del" onclick="showDeleteConfirm('${escapeJs(r.name)}')">Del</button>
                        </td>
                    </tr>`
                ).join('') : '<tr><td colspan="5" style="text-align:center;color:#888">No recordings found</td></tr>';
            } catch (e) { console.error(e); }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function escapeJs(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function toggleRecordingSelection(filename, checked) {
            if (checked) {
                selectedRecordings.add(filename);
            } else {
                selectedRecordings.delete(filename);
            }
            updateBatchDeleteButton();
            updateSelectAllState();
        }

        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.recording-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const filename = cb.getAttribute('data-filename');
                if (checked) {
                    selectedRecordings.add(filename);
                } else {
                    selectedRecordings.delete(filename);
                }
            });
            
            // Sync both select all checkboxes.
            const selectAllHeader = document.getElementById('selectAllHeader');
            const selectAllRecordings = document.getElementById('selectAllRecordings');
            if (selectAllHeader) selectAllHeader.checked = checked;
            if (selectAllRecordings) selectAllRecordings.checked = checked;
            
            updateBatchDeleteButton();
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.recording-checkbox');
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            
            const selectAllHeader = document.getElementById('selectAllHeader');
            const selectAllRecordings = document.getElementById('selectAllRecordings');
            if (selectAllHeader) selectAllHeader.checked = allChecked;
            if (selectAllRecordings) selectAllRecordings.checked = allChecked;
        }

        function updateBatchDeleteButton() {
            const btn = document.getElementById('batchDeleteBtn');
            const countSpan = document.getElementById('selectedCount');
            if (btn && countSpan) {
                countSpan.textContent = selectedRecordings.size;
                btn.style.display = selectedRecordings.size > 0 ? 'inline-block' : 'none';
            }
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ============================================================
        // xterm.js based Recording Player (asciinema-like experience)
        // ============================================================
        let term = null;
        let fitAddon = null;
        let playbackData = [];
        let playbackIndex = 0;
        let playbackTimer = null;
        let playbackSpeed = 1;
        let isPlaying = false;
        let totalDuration = 0;
        let currentFilename = '';

        function initTerminal() {
            if (term) {
                term.dispose();
            }
            
            term = new Terminal({
                cursorBlink: false,
                cursorStyle: 'block',
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4',
                    cursor: '#d4d4d4',
                    black: '#000000',
                    red: '#cd3131',
                    green: '#0dbc79',
                    yellow: '#e5e510',
                    blue: '#2472c8',
                    magenta: '#bc3fbc',
                    cyan: '#11a8cd',
                    white: '#e5e5e5',
                    brightBlack: '#666666',
                    brightRed: '#f14c4c',
                    brightGreen: '#23d18b',
                    brightYellow: '#f5f543',
                    brightBlue: '#3b8eea',
                    brightMagenta: '#d670d6',
                    brightCyan: '#29b8db',
                    brightWhite: '#ffffff'
                },
                scrollback: 5000,
                convertEol: true
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            
            const container = document.getElementById('terminal-container');
            container.innerHTML = '';
            term.open(container);
            
            // Fit terminal to container
            setTimeout(() => {
                fitAddon.fit();
            }, 100);
        }

        // Live session watching.
        let watchWs = null;
        let watchTerminal = null;

        function watchSession(sessionId, username, hostname) {
            document.getElementById('watchSessionTitle').textContent = `Live: ${username}@${hostname}`;
            document.getElementById('watchSessionModal').classList.add('active');
            
            // Initialize terminal after modal is visible.
            setTimeout(() => {
                const termContainer = document.getElementById('watchTerminal');
                termContainer.innerHTML = '';
                
                watchTerminal = new Terminal({
                    cursorBlink: false,
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    theme: { background: '#1e1e1e', foreground: '#d4d4d4' }
                });
                
                const fitAddon = new FitAddon.FitAddon();
                watchTerminal.loadAddon(fitAddon);
                watchTerminal.open(termContainer);
                fitAddon.fit();
                
                watchTerminal.writeln('\x1b[33m--- Live session view (read-only) ---\x1b[0m\r\n');
                
                // Connect WebSocket.
                const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${location.host}/api/sessions/watch/${sessionId}?token=${token}`;
                
                watchWs = new WebSocket(wsUrl);
                watchWs.binaryType = 'arraybuffer';
                
                watchWs.onopen = () => {
                    watchTerminal.writeln('\x1b[32m--- Connected ---\x1b[0m\r\n');
                };
                
                watchWs.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        const text = new TextDecoder().decode(event.data);
                        watchTerminal.write(text);
                    } else {
                        watchTerminal.write(event.data);
                    }
                };
                
                watchWs.onclose = () => {
                    watchTerminal.writeln('\r\n\x1b[33m--- Session ended ---\x1b[0m');
                };
                
                watchWs.onerror = (err) => {
                    watchTerminal.writeln('\r\n\x1b[31m--- Connection error ---\x1b[0m');
                };
                
                // Handle window resize.
                window.addEventListener('resize', () => fitAddon.fit());
            }, 100);
        }

        function closeWatchSession() {
            if (watchWs) {
                watchWs.close();
                watchWs = null;
            }
            if (watchTerminal) {
                watchTerminal.dispose();
                watchTerminal = null;
            }
            document.getElementById('watchSessionModal').classList.remove('active');
        }

        async function playRecording(filename) {
            try {
                currentFilename = filename;
                document.getElementById('playerTitle').textContent = 'Recording: ' + filename;
                
                const res = await fetch('/api/recordings/' + filename, { headers: { 'Authorization': 'Bearer ' + token } });
                if (!res.ok) throw new Error('Failed to load recording');
                const text = await res.text();
                const lines = text.trim().split('\n');
                
                // Parse header
                const header = JSON.parse(lines[0]);
                
                // Parse events: {"time": ms, "type": "o"|"i", "data": "..."}
                playbackData = [];
                for (let i = 1; i < lines.length; i++) {
                    try {
                        const obj = JSON.parse(lines[i]);
                        // time in ms, convert to seconds
                        playbackData.push({
                            time: obj.time / 1000,
                            type: obj.type,
                            data: obj.data
                        });
                    } catch (e) {
                        console.warn('Failed to parse line:', lines[i]);
                    }
                }
                
                if (playbackData.length === 0) {
                    alert('Recording is empty');
                    return;
                }
                
                totalDuration = playbackData[playbackData.length - 1].time;
                playbackIndex = 0;
                isPlaying = false;
                
                // Reset UI
                document.getElementById('playBtn').innerHTML = '‚ñ∂ Play';
                document.getElementById('progressBar').value = 0;
                document.getElementById('progressBar').max = totalDuration * 100;
                document.getElementById('currentTime').textContent = '0:00';
                document.getElementById('totalTime').textContent = formatTime(totalDuration);
                document.getElementById('playbackSpeed').value = '1';
                playbackSpeed = 1;
                
                showModal('playerModal');
                
                // Initialize terminal after modal is visible
                setTimeout(() => {
                    initTerminal();
                    // Resize terminal to match header dimensions if available
                    if (header.width && header.height) {
                        term.resize(header.width, header.height);
                    }
                }, 150);
                
            } catch (e) {
                alert('Failed to load recording: ' + e.message);
                console.error(e);
            }
        }

        function togglePlayback() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (playbackIndex >= playbackData.length) {
                // Restart if at end
                restartPlayback();
            }
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = '‚è∏ Pause';
            scheduleNextFrame();
        }

        function pausePlayback() {
            isPlaying = false;
            if (playbackTimer) {
                clearTimeout(playbackTimer);
                playbackTimer = null;
            }
            document.getElementById('playBtn').innerHTML = '‚ñ∂ Play';
        }

        function scheduleNextFrame() {
            if (!isPlaying || playbackIndex >= playbackData.length) {
                if (playbackIndex >= playbackData.length) {
                    isPlaying = false;
                    document.getElementById('playBtn').innerHTML = '‚ñ∂ Play';
                }
                return;
            }
            
            const currentEvent = playbackData[playbackIndex];
            const prevTime = playbackIndex > 0 ? playbackData[playbackIndex - 1].time : 0;
            let delay = (currentEvent.time - prevTime) * 1000 / playbackSpeed;
            
            // Cap maximum delay to 2 seconds for better UX
            delay = Math.min(delay, 2000 / playbackSpeed);
            delay = Math.max(delay, 1);
            
            playbackTimer = setTimeout(() => {
                renderFrame(playbackIndex);
                playbackIndex++;
                updateProgress();
                scheduleNextFrame();
            }, delay);
        }

        function renderFrame(index) {
            if (!term || index >= playbackData.length) return;
            
            const event = playbackData[index];
            if (event.type === 'o') {
                term.write(event.data);
            }
        }

        function renderUpToIndex(targetIndex) {
            if (!term) return;
            term.reset();
            
            for (let i = 0; i <= targetIndex && i < playbackData.length; i++) {
                const event = playbackData[i];
                if (event.type === 'o') {
                    term.write(event.data);
                }
            }
        }

        function restartPlayback() {
            pausePlayback();
            playbackIndex = 0;
            if (term) {
                term.reset();
            }
            updateProgress();
        }

        function updatePlaybackSpeed() {
            playbackSpeed = parseFloat(document.getElementById('playbackSpeed').value);
        }

        function updateProgress() {
            if (playbackData.length === 0) return;
            
            const currentTime = playbackIndex > 0 ? playbackData[Math.min(playbackIndex, playbackData.length - 1)].time : 0;
            document.getElementById('currentTime').textContent = formatTime(currentTime);
            document.getElementById('progressBar').value = currentTime * 100;
        }

        function seekPreview(value) {
            const time = value / 100;
            document.getElementById('currentTime').textContent = formatTime(time);
        }

        function seekTo(value) {
            const targetTime = value / 100;
            
            // Find the index closest to target time
            let targetIndex = 0;
            for (let i = 0; i < playbackData.length; i++) {
                if (playbackData[i].time <= targetTime) {
                    targetIndex = i;
                } else {
                    break;
                }
            }
            
            const wasPlaying = isPlaying;
            pausePlayback();
            
            playbackIndex = targetIndex;
            renderUpToIndex(targetIndex);
            updateProgress();
            
            if (wasPlaying) {
                startPlayback();
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === undefined) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // ============================================================
        // Custom Confirm Dialog
        // ============================================================
        let confirmCallback = null;

        function showConfirmDialog(title, message, details, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const detailsEl = document.getElementById('confirmDetails');
            if (details && details.length > 0) {
                detailsEl.innerHTML = details.map(d => escapeHtml(d)).join('<br>');
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
            
            confirmCallback = onConfirm;
            document.getElementById('confirmOkBtn').onclick = executeConfirm;
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        }

        function executeConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        function showDeleteConfirm(filename) {
            showConfirmDialog(
                'Delete Recording',
                `Are you sure you want to delete "${filename}"?`,
                null,
                async () => {
                    try {
                        await fetch('/api/recordings/' + encodeURIComponent(filename), {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + token }
                        });
                        loadRecordings();
                    } catch (e) { console.error(e); }
                }
            );
        }

        function showBatchDeleteConfirm() {
            if (selectedRecordings.size === 0) return;
            
            const filenames = Array.from(selectedRecordings);
            showConfirmDialog(
                'Batch Delete Recordings',
                `Are you sure you want to delete ${filenames.length} recording(s)?`,
                filenames.length <= 10 ? filenames : [...filenames.slice(0, 10), `... and ${filenames.length - 10} more`],
                async () => {
                    try {
                        const res = await fetch('/api/recordings', {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ filenames: filenames })
                        });
                        const data = await res.json();
                        if (data.failed && Object.keys(data.failed).length > 0) {
                            console.warn('Some files failed to delete:', data.failed);
                        }
                        loadRecordings();
                    } catch (e) { console.error(e); }
                }
            );
        }

        // Legacy function kept for compatibility but now uses custom dialog.
        async function deleteRecording(filename) {
            showDeleteConfirm(filename);
        }

        function showModal(id) { 
            document.getElementById(id).classList.add('active'); 
            if (id === 'addHostModal') populateKeyDropdown();
        }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active');
            if (id === 'playerModal') {
                pausePlayback();
                if (term) {
                    term.dispose();
                    term = null;
                }
            }
        }

        function populateKeyDropdown() {
            const sel = document.getElementById('hostKeyId');
            sel.innerHTML = '<option value="">-- None --</option>' + allKeys.map(k => 
                `<option value="${k.id}">${k.name} (${k.key_type})</option>`
            ).join('');
        }

        function resetHostForm() {
            document.getElementById('hostModalTitle').textContent = 'Add Host';
            document.getElementById('hostSubmitBtn').textContent = 'Add';
            document.getElementById('hostEditId').value = '';
            document.getElementById('hostName').value = '';
            document.getElementById('hostAddr').value = '';
            document.getElementById('hostPort').value = '22';
            document.getElementById('hostUser').value = '';
            document.getElementById('hostKeyId').value = '';
            document.getElementById('hostGroups').value = '';
            document.getElementById('hostInsecure').checked = false;
        }

        function editHost(id) {
            const h = allHosts.find(h => h.id === id);
            if (!h) return;
            document.getElementById('hostModalTitle').textContent = 'Edit Host';
            document.getElementById('hostSubmitBtn').textContent = 'Save';
            document.getElementById('hostEditId').value = h.id;
            document.getElementById('hostName').value = h.name;
            document.getElementById('hostAddr').value = h.addr;
            document.getElementById('hostPort').value = h.port;
            document.getElementById('hostUser').value = h.user || '';
            document.getElementById('hostGroups').value = (h.groups||[]).join(', ');
            document.getElementById('hostInsecure').checked = h.insecure_ignore_host_key || false;
            populateKeyDropdown();
            document.getElementById('hostKeyId').value = h.key_id || '';
            showModal('addHostModal');
        }

        document.getElementById('addHostForm').onsubmit = async (e) => {
            e.preventDefault();
            const f = e.target;
            const id = document.getElementById('hostEditId').value;
            const data = { 
                name: f.name.value, 
                addr: f.addr.value, 
                port: parseInt(f.port.value), 
                user: f.user.value || 'root',
                key_id: f.key_id.value || '',
                groups: f.groups.value ? f.groups.value.split(',').map(g=>g.trim()) : [],
                insecure_ignore_host_key: document.getElementById('hostInsecure').checked
            };
            if (id) {
                await fetch('/api/hosts/' + id, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                await fetch('/api/hosts', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
            closeModal('addHostModal'); resetHostForm(); loadHosts();
        };

        let editingUserId = null;
        function resetUserForm() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userSubmitBtn').textContent = 'Add';
            document.getElementById('userEditId').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').setAttribute('required', true);
            document.getElementById('passwordGroup').style.display = '';
            document.getElementById('roleGroup').style.display = '';
            document.getElementById('groupsGroup').style.display = '';
            document.getElementById('allowedHostsGroup').style.display = '';
            document.getElementById('userUsername').removeAttribute('readonly');
            // Clear selects
            document.getElementById('userGroups').value = '';
            const rolesSel = document.getElementById('userRoles');
            for (let opt of rolesSel.options) opt.selected = false;
            const hostsSel = document.getElementById('userAllowedHosts');
            for (let opt of hostsSel.options) opt.selected = false;
        }

        async function openAddUserModal() {
            resetUserForm();
            // Load all dropdown data before showing modal
            await Promise.all([
                loadRolesForUserForm(),
                loadGroupsForUserForm(),
                loadHostsForUserForm()
            ]);
            showModal('addUserModal');
        }

        async function loadGroupsForUserForm() {
            try {
                // Get unique groups from hosts (since user groups are matched against host groups)
                const hosts = await (await fetch('/api/hosts', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                const groupSet = new Set();
                (hosts||[]).forEach(h => {
                    (h.groups||[]).forEach(g => groupSet.add(g));
                });
                // Also add some common groups
                ['admin', 'users', 'operators', 'developers'].forEach(g => groupSet.add(g));
                const sel = document.getElementById('userGroups');
                sel.innerHTML = '<option value="">Select a group...</option>';
                Array.from(groupSet).sort().forEach(g => {
                    sel.innerHTML += `<option value="${g}">${g}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        async function loadHostsForUserForm() {
            try {
                const hosts = await (await fetch('/api/hosts', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                const sel = document.getElementById('userAllowedHosts');
                sel.innerHTML = '';
                (hosts||[]).forEach(h => {
                    sel.innerHTML += `<option value="${h.name}">${h.name} (${h.addr})</option>`;
                });
            } catch (e) {}
        }

        async function editUser(id) {
            try {
                await Promise.all([
                    loadRolesForUserForm(),
                    loadGroupsForUserForm(),
                    loadHostsForUserForm()
                ]);
                const users = await (await fetch('/api/users', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                const u = (users||[]).find(u => u.id === id);
                if (!u) return;
                editingUserId = id;
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userSubmitBtn').textContent = 'Save';
                document.getElementById('userEditId').value = u.id;
                document.getElementById('userUsername').value = u.username;
                document.getElementById('userUsername').setAttribute('readonly', true);
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').removeAttribute('required');
                document.getElementById('passwordGroup').style.display = 'none';
                
                // Show role selection for users with iam:manage permission (except for admin user)
                const canManageRoles = hasPermission('iam:manage') && u.username !== 'admin';
                document.getElementById('roleGroup').style.display = canManageRoles ? '' : 'none';
                
                // Set current roles (multi-select)
                if (canManageRoles) {
                    const roleSel = document.getElementById('userRoles');
                    const userRoleNames = (u.roles || []).map(r => r.toLowerCase());
                    for (let opt of roleSel.options) {
                        const optName = (opt.getAttribute('data-name') || opt.text).toLowerCase();
                        opt.selected = userRoleNames.some(rn => optName.includes(rn) || rn.includes(optName));
                    }
                }
                
                // Set selected group (first group in array or empty)
                const groupsSel = document.getElementById('userGroups');
                groupsSel.value = (u.groups && u.groups.length > 0) ? u.groups[0] : '';
                // Set selected hosts
                const hostsSel = document.getElementById('userAllowedHosts');
                for (let opt of hostsSel.options) {
                    opt.selected = (u.allowed_hosts||[]).includes(opt.value);
                }
                showModal('addUserModal');
            } catch (e) { console.error(e); }
        }

        // Load roles for user creation dropdown (multi-select)
        async function loadRolesForUserForm() {
            try {
                const roles = await (await fetch('/api/iam/roles', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                allRoles = roles || [];
                const sel = document.getElementById('userRoles');
                sel.innerHTML = '';
                allRoles.forEach(r => {
                    sel.innerHTML += `<option value="${r.id}" data-name="${r.name}">${r.display_name || r.name}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        // Helper to get selected values from multi-select
        function getSelectedValues(selectEl) {
            return Array.from(selectEl.selectedOptions).map(opt => opt.value);
        }

        document.getElementById('addUserForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('userEditId').value;
            const groupVal = document.getElementById('userGroups').value;
            const groups = groupVal ? [groupVal] : [];
            const allowedHosts = getSelectedValues(document.getElementById('userAllowedHosts'));
            const selectedRoleIds = getSelectedValues(document.getElementById('userRoles'));
            
            if (id) {
                // Update user basic info
                await fetch('/api/users/' + id, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        groups: groups,
                        allowed_hosts: allowedHosts
                    })
                });
                
                // Update roles if user has iam:manage permission
                if (hasPermission('iam:manage')) {
                    // Get current roles
                    const currentRoles = await (await fetch('/api/iam/user-roles/' + id, { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                    const currentRoleIds = currentRoles.map(r => r.id);
                    
                    // Remove roles that are no longer selected
                    for (const role of currentRoles) {
                        if (!selectedRoleIds.includes(role.id)) {
                            await fetch('/api/iam/user-roles/' + id + '?role_id=' + role.id, {
                                method: 'DELETE',
                                headers: { 'Authorization': 'Bearer ' + token }
                            });
                        }
                    }
                    
                    // Add newly selected roles
                    for (const roleId of selectedRoleIds) {
                        if (!currentRoleIds.includes(roleId)) {
                            await fetch('/api/iam/user-roles/' + id, {
                                method: 'POST',
                                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ role_id: roleId })
                            });
                        }
                    }
                }
            } else {
                const username = document.getElementById('userUsername').value;
                const password = document.getElementById('userPassword').value;
                // Create user first
                const resp = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: username, 
                        password: password, 
                        groups: groups,
                        allowed_hosts: allowedHosts,
                        role_id: selectedRoleIds[0] || '' // First role assigned at creation
                    })
                });
                
                // Assign additional roles if more than one selected
                if (resp.ok && selectedRoleIds.length > 1) {
                    const newUser = await resp.json();
                    for (let i = 1; i < selectedRoleIds.length; i++) {
                        await fetch('/api/iam/user-roles/' + newUser.id, {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ role_id: selectedRoleIds[i] })
                        });
                    }
                }
            }
            closeModal('addUserModal'); resetUserForm(); loadUsers();
        };

        document.getElementById('addKeyForm').onsubmit = async (e) => {
            e.preventDefault();
            const f = e.target;
            await fetch('/api/keys', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: f.name.value, key_type: f.key_type.value })
            });
            closeModal('addKeyModal'); f.reset(); loadKeys(); loadKeysCache();
        };

        async function deleteHost(id) { if (confirm('Delete host?')) { await fetch('/api/hosts/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadHosts(); } }
        async function deleteUser(id) { if (confirm('Delete user?')) { await fetch('/api/users/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadUsers(); } }
        async function deleteKey(id) { if (confirm('Delete key?')) { await fetch('/api/keys/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadKeys(); } }
        function copyKey(b64) { navigator.clipboard.writeText(atob(b64)); alert('Public key copied!'); }

        // ============================================================
        // IAM (Identity & Access Management)
        // ============================================================
        let allPermissions = [];
        let allUsersForIam = [];

        function showIamTab(tab) {
            document.querySelectorAll('.iam-tab').forEach(el => el.style.display = 'none');
            document.querySelectorAll('[id^="iamTab"]').forEach(btn => { btn.style.background = '#fff'; btn.style.color = '#333'; });
            
            if (tab === 'roles') {
                document.getElementById('iam-roles').style.display = 'block';
                document.getElementById('iamTabRoles').style.background = '#333';
                document.getElementById('iamTabRoles').style.color = '#fff';
            } else if (tab === 'user-roles') {
                document.getElementById('iam-user-roles').style.display = 'block';
                document.getElementById('iamTabUserRoles').style.background = '#333';
                document.getElementById('iamTabUserRoles').style.color = '#fff';
                loadUserRoles();
            } else if (tab === 'host-perms') {
                document.getElementById('iam-host-perms').style.display = 'block';
                document.getElementById('iamTabHostPerms').style.background = '#333';
                document.getElementById('iamTabHostPerms').style.color = '#fff';
                loadHostPerms();
            }
        }

        async function loadIam() {
            await Promise.all([loadRoles(), loadPermissions(), loadUsersForIam(), loadHostsForIam()]);
        }

        async function loadHostsForIam() {
            try {
                const hosts = await (await fetch('/api/hosts', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                allHosts = hosts || [];
            } catch (e) { allHosts = []; }
        }

        async function loadPermissions() {
            try {
                allPermissions = await (await fetch('/api/iam/permissions', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
            } catch (e) { allPermissions = []; }
        }

        async function loadUsersForIam() {
            try {
                allUsersForIam = await (await fetch('/api/users', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
            } catch (e) { allUsersForIam = []; }
        }

        async function loadRoles() {
            try {
                allRoles = await (await fetch('/api/iam/roles', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                document.getElementById('roles-table').innerHTML = allRoles.length ? allRoles.map(r => 
                    `<tr>
                        <td><code>${escapeHtml(r.name)}</code></td>
                        <td>${escapeHtml(r.display_name)}</td>
                        <td>${escapeHtml(r.description || '-')}</td>
                        <td style="font-size:10px;max-width:200px;overflow:hidden;text-overflow:ellipsis">${(r.permissions||[]).join(', ') || '-'}</td>
                        <td>${r.is_system ? '<span style="color:#090">‚úì</span>' : '-'}</td>
                        <td>${r.is_system ? '-' : `<button class="btn-sm" onclick="editRole('${r.id}')">Edit</button> <button class="btn-sm btn-del" onclick="deleteRole('${r.id}')">Del</button>`}</td>
                    </tr>`
                ).join('') : '<tr><td colspan="6" style="text-align:center;color:#888">No roles defined</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function loadUserRoles() {
            try {
                const userRolesMap = {};
                for (const u of allUsersForIam) {
                    const roles = await (await fetch('/api/iam/user-roles/' + u.id, { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                    userRolesMap[u.id] = { user: u, roles: roles };
                }
                document.getElementById('user-roles-table').innerHTML = Object.keys(userRolesMap).length ? 
                    Object.values(userRolesMap).map(item => {
                        const roleNames = item.roles.map(r => r.display_name || r.name).join(', ') || '<span style="color:#888">No roles</span>';
                        const roleBadges = item.roles.map(r => `<button class="btn-sm btn-del" style="font-size:9px;padding:1px 4px" onclick="removeUserRole('${item.user.id}','${r.id}')">${escapeHtml(r.name)} ‚úï</button>`).join(' ');
                        return `<tr><td>${escapeHtml(item.user.username)}</td><td>${roleNames}</td><td>${roleBadges || '-'}</td></tr>`;
                    }).join('') : '<tr><td colspan="3" style="text-align:center;color:#888">No users</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function loadHostPerms() {
            try {
                const perms = await (await fetch('/api/iam/host-permissions', { headers: { 'Authorization': 'Bearer ' + token } })).json() || [];
                document.getElementById('host-perms-table').innerHTML = perms.length ? perms.map(p => {
                    const userName = allUsersForIam.find(u => u.id === p.user_id)?.username || p.user_id.slice(0,8);
                    const hostName = allHosts.find(h => h.id === p.host_id)?.name || p.host_id.slice(0,8);
                    const expires = p.expires_at ? new Date(p.expires_at).toLocaleString() : 'Never';
                    return `<tr>
                        <td>${escapeHtml(userName)}</td>
                        <td>${escapeHtml(hostName)}</td>
                        <td><code style="font-size:10px">${(p.actions||[]).join(', ')}</code></td>
                        <td>${p.granted_by ? p.granted_by.slice(0,8) : '-'}</td>
                        <td>${expires}</td>
                        <td><button class="btn-sm btn-del" onclick="revokeHostPerm('${p.id}')">Revoke</button></td>
                    </tr>`;
                }).join('') : '<tr><td colspan="6" style="text-align:center;color:#888">No host permissions</td></tr>';
            } catch (e) { console.error(e); }
        }

        function populatePermissionCheckboxes(selectedPerms) {
            const container = document.getElementById('permissionCheckboxes');
            const perms = selectedPerms || [];
            const groups = {};
            allPermissions.forEach(p => {
                const [cat] = p.name.split(':');
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(p);
            });
            let html = '';
            Object.keys(groups).sort().forEach(cat => {
                html += `<div style="margin-bottom:8px"><strong>${cat}</strong><br>`;
                groups[cat].forEach(p => {
                    const checked = perms.includes(p.name) ? 'checked' : '';
                    html += `<label style="margin-right:8px"><input type="checkbox" name="permissions" value="${p.name}" ${checked}> ${p.name.split(':')[1]}</label>`;
                });
                html += '</div>';
            });
            container.innerHTML = html || 'No permissions available';
        }

        function resetRoleForm() {
            document.getElementById('roleModalTitle').textContent = 'Add Role';
            document.getElementById('roleSubmitBtn').textContent = 'Add';
            document.getElementById('roleEditId').value = '';
            document.getElementById('roleName').value = '';
            document.getElementById('roleName').removeAttribute('readonly');
            document.getElementById('roleDisplayName').value = '';
            document.getElementById('roleDescription').value = '';
            populatePermissionCheckboxes([]);
        }

        function editRole(id) {
            const r = allRoles.find(r => r.id === id);
            if (!r || r.is_system) return;
            document.getElementById('roleModalTitle').textContent = 'Edit Role';
            document.getElementById('roleSubmitBtn').textContent = 'Save';
            document.getElementById('roleEditId').value = r.id;
            document.getElementById('roleName').value = r.name;
            document.getElementById('roleName').setAttribute('readonly', true);
            document.getElementById('roleDisplayName').value = r.display_name;
            document.getElementById('roleDescription').value = r.description || '';
            populatePermissionCheckboxes(r.permissions || []);
            showModal('addRoleModal');
        }

        document.getElementById('addRoleForm').onsubmit = async (e) => {
            e.preventDefault();
            const f = e.target;
            const id = document.getElementById('roleEditId').value;
            const perms = Array.from(f.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
            const data = {
                name: f.name.value,
                display_name: f.display_name.value,
                description: f.description.value,
                permissions: perms
            };
            if (id) {
                await fetch('/api/iam/roles/' + id, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                await fetch('/api/iam/roles', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
            closeModal('addRoleModal'); resetRoleForm(); loadRoles();
        };

        async function deleteRole(id) {
            if (confirm('Delete this role?')) {
                await fetch('/api/iam/roles/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                loadRoles();
            }
        }

        function populateUserDropdown(selectId) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">-- Select User --</option>' + allUsersForIam.map(u => 
                `<option value="${u.id}">${escapeHtml(u.username)}</option>`
            ).join('');
        }

        function populateRoleDropdown(selectId) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">-- Select Role --</option>' + allRoles.map(r => 
                `<option value="${r.id}">${escapeHtml(r.display_name)} (${r.name})</option>`
            ).join('');
        }

        function populateHostDropdown(selectId) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">-- Select Host --</option>' + allHosts.map(h => 
                `<option value="${h.id}">${escapeHtml(h.name)} (${h.addr})</option>`
            ).join('');
        }

        document.getElementById('assignRoleForm').onsubmit = async (e) => {
            e.preventDefault();
            const f = e.target;
            await fetch('/api/iam/user-roles/' + f.user_id.value, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ role_id: f.role_id.value })
            });
            closeModal('assignRoleModal'); loadUserRoles();
        };

        async function removeUserRole(userId, roleId) {
            if (confirm('Remove this role from user?')) {
                await fetch('/api/iam/user-roles/' + userId + '?role_id=' + roleId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                loadUserRoles();
            }
        }

        document.getElementById('grantHostForm').onsubmit = async (e) => {
            e.preventDefault();
            const f = e.target;
            const actions = Array.from(f.querySelectorAll('input[name="actions"]:checked')).map(cb => cb.value);
            const data = {
                user_id: f.user_id.value,
                host_id: f.host_id.value,
                actions: actions,
                expires_at: f.expires_at.value ? new Date(f.expires_at.value).toISOString() : null
            };
            await fetch('/api/iam/host-permissions', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            closeModal('grantHostModal'); loadHostPerms();
        };

        async function revokeHostPerm(id) {
            if (confirm('Revoke this host permission?')) {
                await fetch('/api/iam/host-permissions/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                loadHostPerms();
            }
        }

        // Override showModal for IAM modals
        const originalShowModal = showModal;
        showModal = function(id) {
            if (id === 'addRoleModal') {
                if (!document.getElementById('roleEditId').value) {
                    resetRoleForm();
                }
            } else if (id === 'assignRoleModal') {
                populateUserDropdown('assignRoleUserId');
                populateRoleDropdown('assignRoleRoleId');
            } else if (id === 'grantHostModal') {
                populateUserDropdown('grantHostUserId');
                populateHostDropdown('grantHostHostId');
                document.getElementById('grantHostExpires').value = '';
            }
            originalShowModal(id);
        };

        // OTP Settings Functions
        async function loadSettings() {
            await loadOTPStatus();
            await loadOTPGlobalSettings();
        }

        async function loadOTPStatus() {
            try {
                const status = await (await fetch('/api/otp/status', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                const container = document.getElementById('otp-status-display');
                
                if (status.enabled && status.verified) {
                    container.innerHTML = `
                        <div style="color:#090;font-weight:bold;margin-bottom:10px">‚úì OTP is enabled for your account</div>
                        <p style="font-size:12px;color:#666">You will be prompted for OTP code when connecting via SSH.</p>
                        <button class="btn-sm btn-del" onclick="disableOTP()" style="margin-top:10px">Disable OTP</button>
                    `;
                } else {
                    const forceMsg = status.force_enabled ? '<p style="color:#c00;font-size:12px;margin-bottom:10px">‚ö† OTP is required by your administrator.</p>' : '';
                    container.innerHTML = `
                        ${forceMsg}
                        <div style="margin-bottom:10px">OTP is not enabled for your account.</div>
                        <button class="btn-sm btn-add" onclick="setupOTP()">Enable OTP</button>
                    `;
                }
            } catch (e) {
                console.error('Failed to load OTP status:', e);
            }
        }

        async function loadOTPGlobalSettings() {
            try {
                const settings = await (await fetch('/api/settings/otp', { headers: { 'Authorization': 'Bearer ' + token } })).json();
                document.getElementById('otpForceEnabled').checked = settings.force_enabled;
            } catch (e) {
                console.error('Failed to load global OTP settings:', e);
            }
        }

        async function setupOTP() {
            try {
                const resp = await fetch('/api/otp/setup', { 
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await resp.json();
                
                if (!resp.ok) {
                    alert('Failed to setup OTP: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                // Show QR code modal
                const container = document.getElementById('otp-status-display');
                container.innerHTML = `
                    <div style="text-align:center">
                        <h4 style="margin-bottom:15px">Scan this QR code with your authenticator app</h4>
                        <img src="data:image/png;base64,${data.qr_code}" alt="OTP QR Code" style="border:1px solid #ccc;padding:10px;background:#fff">
                        <p style="margin-top:15px;font-size:12px">Or enter this secret manually:</p>
                        <code style="user-select:all;font-size:14px;background:#f0f0f0;padding:8px;display:inline-block;margin:10px 0">${data.secret}</code>
                        <div style="margin-top:20px">
                            <label>Enter the 6-digit code from your app to verify:</label>
                            <div style="margin-top:10px;display:flex;gap:10px;justify-content:center;align-items:center">
                                <input type="text" id="otpVerifyCode" maxlength="6" style="width:120px;text-align:center;font-size:18px;padding:8px" placeholder="000000">
                                <button class="btn-sm btn-add" onclick="verifyOTP()">Verify & Enable</button>
                            </div>
                        </div>
                        <button class="btn-sm" onclick="loadOTPStatus()" style="margin-top:15px">Cancel</button>
                    </div>
                `;
            } catch (e) {
                alert('Error setting up OTP: ' + e.message);
            }
        }

        async function verifyOTP() {
            const code = document.getElementById('otpVerifyCode').value.trim();
            if (!code || code.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }
            
            try {
                const resp = await fetch('/api/otp/verify', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                const data = await resp.json();
                
                if (!resp.ok) {
                    alert('Verification failed: ' + (data.error || 'Invalid code'));
                    return;
                }
                
                alert('OTP enabled successfully!');
                loadOTPStatus();
            } catch (e) {
                alert('Error verifying OTP: ' + e.message);
            }
        }

        async function disableOTP() {
            if (!confirm('Are you sure you want to disable OTP? This will reduce your account security.')) {
                return;
            }
            
            try {
                const resp = await fetch('/api/otp', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await resp.json();
                
                if (!resp.ok) {
                    alert('Failed to disable OTP: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                alert('OTP disabled.');
                loadOTPStatus();
            } catch (e) {
                alert('Error disabling OTP: ' + e.message);
            }
        }

        async function updateOTPGlobalSetting() {
            const forceEnabled = document.getElementById('otpForceEnabled').checked;
            
            try {
                const resp = await fetch('/api/settings/otp', {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force_enabled: forceEnabled })
                });
                const data = await resp.json();
                
                if (!resp.ok) {
                    alert('Failed to update setting: ' + (data.error || 'Unknown error'));
                    document.getElementById('otpForceEnabled').checked = !forceEnabled;
                    return;
                }
            } catch (e) {
                alert('Error updating setting: ' + e.message);
                document.getElementById('otpForceEnabled').checked = !forceEnabled;
            }
        }
    </script>
</body>
</html>